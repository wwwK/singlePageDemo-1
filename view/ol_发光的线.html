<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<script src="../js/ol.js"></script>
		<script src="../js/ol-ext.js"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/turf.min.js"></script>
		<style>
			html,
			body,
			.map {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
	</head>

	<body>
		<div class="map" id="map">

		</div>
		<script>
			let map = new ol.Map({
				target: 'map',
				interactions: ol.interaction.defaults({
					altShiftDragRotate: false,
					pinchRotate: false
				}),
				view: new ol.View({
					center: ol.proj.transform([104, 30], 'EPSG:4326', 'EPSG:3857'),
					zoom: 8,
					maxZoom: 18,
					minZoom: 2
				})
			});

			var region = 'POLYGON((104 30,105 30,105 31,104.5 32,104 31,104 30))';
			var format = new ol.format.WKT();

			function xyzToLonlat(x, y, z) {
				var n = Math.pow(2, z);
				var lon = x / n * 360.0 - 180.0;
				var lat = Math.atan(Math.sin(Math.PI * (1 - 2 * Math.abs(y) / n)));
				lat = lat * 180.0 / Math.PI;

				var step = 180 / n;
				return [lon, lat - step, lon + step, lat]
			}

			function lonlatToXYZ(lon, lat, zoom) {
				var n = Math.pow(2, zoom);
				var tileX = parseInt(((lon + 180) / 360) * n);
				var tileY = parseInt((1 - (Math.log(Math.tan(Math.PI / 180 * lat) + (1 / Math.cos(Math.PI / 180 * lat))) / Math.PI)) / 2 * n);
				return {
					tileX,
					tileY
				}
			}

			let roadLayer = new ol.layer.Tile({
				title: "3857底图",
				source: new ol.source.XYZ({
					tileUrlFunction: function(tileCoord) {
						let oo = "00000000";
						let zz = tileCoord[0];
						if(zz < 10) {
							zz = '0' + zz;
						}
						let z = "L" + zz;

						let xx = tileCoord[1].toString(16);
						let x = "C" + oo.substring(0, 8 - xx.length) + xx;
						let yy = (-tileCoord[2] - 1).toString(16); //注意此处，计算方式变了
						let y = "R" + oo.substring(0, 8 - yy.length) + yy;
						console.log(tileCoord)
						return 'http://223.86.3.47:28080/api/Handler/Utils.ashx?method=convertRoad&x=' + z + '&y=' + y + '&z=' + x
					},
					tileLoadFunction: function(imageTile, src) {
						let tileCoord = imageTile.tileCoord;
						let img = new Image();
						let feature = format.readFeature(region);
						img.setAttribute('crossOrigin', 'anonymous');
						let canvas = document.createElement("canvas");
						canvas.width = 256;
						canvas.height = 256;
						let ctx = canvas.getContext("2d");
						img.onload = function() {
							ctx.drawImage(img, 0, 0, img.width, img.height);
							var imgData = ctx.getImageData(0, 0, img.width, img.height);
							var data = imgData.data;

//							for(var i = 0; i < data.length; i += 4) {
//								var r = data[i + 0];
//								var g = data[i + 1];
//								var b = data[i + 2];
//								var a = data[i + 3];
//								//黑色风格
//								//灰色风格
//								data[i + 0] = 0 * r + 1 * g + 0 * b + 0 * a + 0
//								data[i + 1] = 0 * r + 1 * g + 0 * b + 0 * a + 0
//								data[i + 2] = 0 * r + 1 * g + 0 * b + 0 * a + 0
//								data[i + 3] = 0 * r + 1 * g + 0 * b + 1 * a + 0
//							}

							ctx.putImageData(imgData, 0, 0);
							let dataURL = canvas.toDataURL("image/png");
							imageTile.getImage().src = dataURL;
						};
						img.src = src;
					},
					projection: 'EPSG:3857'
				})
			});
			map.addLayer(roadLayer);

			let rangeLyaer = new ol.layer.Vector({
				source: new ol.source.Vector({
					features: []
				})
			});
			map.addLayer(rangeLyaer);

			var wktstr = 'POLYGON((103.94618883905346 30.726887168653164,103.93852462112814 30.727567112106428,103.93531733469123 30.726017149676654,103.93177422237751 30.72316387514487,103.93025999226981 30.721592755666748,103.92943447839923 30.720154565402893,103.92952339007819 30.71862318731934,103.93010148175047 30.716471446231946,103.93048195788087 30.71305856429908,103.92979126703011 30.71051072131205,103.9278305897272 30.70961170468532,103.92624905237487 30.710721114773268,103.92453363428521 30.710607147633947,103.92364196523391 30.709380708902728,103.92335240361491 30.708621379746827,103.92336243390794 30.70755187704018,103.92292208927783 30.706474851655994,103.9222120906129 30.705566011755877,103.92023663445124 30.70557392022317,103.91638008042064 30.704035874439136,103.91606841811507 30.70361430480364,103.91638013256924 30.70277246987223,103.91773874292235 30.701182157120616,103.91773879277535 30.699974723525763,103.91807348204215 30.6984611579305,103.91731538493916 30.696870514020038,103.91613567628588 30.695701961369842,103.91188262391438 30.69400548288471,103.9097543515219 30.69055613897883,103.90860416623094 30.689189256591707,103.90730397833967 30.68827215800226,103.90501715450833 30.687613120128056,103.90385961017839 30.68816910953471,103.90165335684125 30.68755569215162,103.90147546880864 30.685984426838974,103.90208437057315 30.684273151805627,103.89717529864188 30.681750293228657,103.89759932501883 30.680542882917013,103.89962614354793 30.679219574909645,103.90167571184745 30.678779684839924,103.90336824279228 30.677226172119695,103.90650987707943 30.676881593002204,103.9096680084925 30.676052781110307,103.91114401588027 30.674236887807567,103.91526544693666 30.673890544433853,103.91822936973445 30.672720795835524,103.92232834158715 30.671571515289468,103.92391017828298 30.670900149435468,103.92464518467341 30.669252070436357,103.92703169715637 30.665622876072,103.92746906788129 30.663963066181886,103.92639682310003 30.662487022857512,103.92636688835266 30.662033257341317,103.9265276524918 30.66169121409689,103.92718563242889 30.661282591502815,103.92783559255491 30.66113784467892,103.92967250037246 30.661651231415696,103.93044616407914 30.66146626241486,103.93109600997707 30.66151933746176,103.93165598940536 30.66178842822382,103.93287169219123 30.663054109423445,103.93349949313108 30.663331052213113,103.93450954127883 30.663353502046917,103.93561137048793 30.663023917660936,103.93624608565034 30.66302289924951,103.9375014701111 30.663446649326172,103.93838659252935 30.663473143716235,103.93925571663337 30.66341567108973,103.93998414009826 30.66282265243295,103.9398983710354 30.661837235620613,103.94007001303467 30.661305164458067,103.94060684372826 30.660620505693366,103.94199269103439 30.660605986852858,103.94356998346038 30.66091888505442,103.9439201274597 30.661415996602642,103.94393204140809 30.662791371641205,103.944287178453 30.663032580119808,103.94549024278847 30.66316016550988,103.94638902928499 30.662760543181303,103.94712024145907 30.661515603677753,103.94806286465392 30.660831959776633,103.9508604890246 30.661277811647643,103.95506280040483 30.66245584631471,103.95645475818509 30.66336219058143,103.95808486764184 30.66599913696946,103.95853652028845 30.666149977199108,103.96073989840654 30.66564078103135,103.9625942816256 30.663265154847533,103.96359314309875 30.663566466926152,103.9648222050314 30.664722777169143,103.96551099080946 30.665066825420638,103.96606321544283 30.665105356287285,103.9671078594769 30.664546834079257,103.96713079513849 30.664306878534987,103.96686965933768 30.66392574068686,103.96687965008113 30.663381952941407,103.96396213119958 30.660017068998282,103.96400002193715 30.65977307750271,103.9647656230245 30.659123375105455,103.96626684103495 30.658479717892355,103.96720980887217 30.657949446106272,103.96732344805571 30.6577372352176,103.9677998908651 30.657797935004808,103.96796032219709 30.65882505847394,103.96828722121751 30.659509881925928,103.97063034327493 30.66211237639073,103.97134990442495 30.662696140125046,103.97266045276535 30.663214277413292,103.9747373467738 30.663290411436904,103.97509411334363 30.663373364737446,103.97608764523352 30.664042245108874,103.97731835829786 30.66399674036167,103.97814252013062 30.66281688353666,103.97844150180602 30.66205235427883,103.97788848539511 30.66110836459407,103.9768431569442 30.66075952262955,103.9763180106576 30.660177279661013,103.97764244157432 30.65893002360871,103.97878542857082 30.658842759176338,103.97892692559367 30.658936308198594,103.97898369153252 30.659721801445514,103.97974498591952 30.660049445253048,103.97953469743577 30.660815723085225,103.98084103064767 30.661501609348914,103.9816450804195 30.663400417812614,103.98226384999302 30.66377243270165,103.98295636113632 30.663858350256746,103.98358410979984 30.66368656712122,103.98449484588967 30.663160093567384,103.98618870596437 30.66313505021675,103.98637205195226 30.662840630536053,103.98669595594298 30.660928497133984,103.98711943118202 30.660509410048235,103.98764351793844 30.66053582445051,103.98798625242526 30.66084865718941,103.98795726074776 30.663099758909954,103.98889780471987 30.66344077625627,103.98940495350028 30.663265322937473,103.99024395908943 30.661299648389043,103.99088062508598 30.661147787676665,103.99202540452102 30.6612642659432,103.99234124724747 30.66109937926621,103.99263717500016 30.66065667395747,103.9926013430526 30.659833142120615,103.99150442047629 30.659046813692964,103.99119559853861 30.658102160651843,103.99155233342974 30.65699156121456,103.99197977038355 30.656722381247196,103.9925656149056 30.656616648473342,103.99508822304442 30.658276254994625,103.99516391809333 30.658847775913127,103.99479624960716 30.659498612184123,103.99467566273047 30.660250651437405,103.9957575391081 30.663028141081707,103.99594284474004 30.66322349074271,103.99749309140861 30.663534629116068,103.99851930079814 30.663311598810594,104.00062955044262 30.66190578566186,104.00249862208436 30.662327915191053,104.00300675418035 30.662140453829235,104.00367034851594 30.661172863272544,104.00396728348503 30.66049825752301,104.00404502520419 30.659856301930933,104.00387169079877 30.65924909204184,104.00307069001217 30.658231964982846,104.00306474516631 30.657476311211166,104.00394954094213 30.656132209219948,104.00544806112183 30.655308028818972,104.00604785921709 30.65527223234036,104.00800666761185 30.655640174510925,104.01134845980276 30.65691164081924,104.01214355521371 30.657662957300346,104.0129186959296 30.659203996175673,104.0131657983642 30.659421172818647,104.01399879993218 30.659686606331015,104.01647597974724 30.659767340505407,104.01737681175145 30.659496852055877,104.01784717439365 30.659111664176958,104.01801261154866 30.658705365073317,104.0181242796406 30.657359628787884,104.01888373757382 30.654748581353886,104.0193680797941 30.654039503797136,104.02252919117437 30.653686733735704,104.02422943853995 30.6532661982876,104.03001436426855 30.65312869860363,104.03467569333588 30.653194753152047,104.03864971318069 30.654016731971126,104.04399255328522 30.654066501058935,104.04510156769764 30.653558306191982,104.04697659565115 30.65351034421343,104.04994298622144 30.654327951236553,104.0505574644747 30.65432474217306,104.05140141322076 30.654053220059016,104.05185433297088 30.653736488048168,104.05355441209925 30.651380311267978,104.0553703254495 30.64977571629923,104.05803053213263 30.64915141318775,104.06199818792794 30.655216531980855,104.06387662483952 30.65537572213004,104.063696854575 30.657627002655186,104.06385652413475 30.65838444623891,104.06415396245649 30.658691892004526,104.06515215103019 30.658810456950473,104.06511414630945 30.66039381866389,104.06546950400671 30.66062323573363,104.07109633151514 30.66077425898653,104.07122407451584 30.662241476321874,104.07213275457704 30.662136542207378,104.0771218766763 30.669868406076766,104.08352751234716 30.667043238719245,104.08682674516028 30.672455280555756,104.08546168481058 30.673191534095455,104.08381091485512 30.674835614536516,104.08277179264803 30.67519203209909,104.0806537783924 30.675405264865375,104.07606276896978 30.678245561546877,104.07425306148876 30.678778991065453,104.07224975239679 30.6802923263365,104.06841158453665 30.680862436437412,104.06594765235532 30.682668760964454,104.06361183100098 30.68340564984263,104.06139801609909 30.684564392126564,104.06041196450191 30.684899762300212,104.05994095504704 30.6841108646144,104.05890323683774 30.681009943190144,104.05840231259552 30.680471008381105,104.0578335235129 30.68040198404628,104.05523920770169 30.68072631073888,104.05250563217473 30.678792190223398,104.05167563782192 30.67844192534775,104.05095738882916 30.678335359334316,104.05018332972237 30.677589211572965,104.04945718735559 30.676593102595486,104.04936744556312 30.67587560501281,104.04799107330516 30.67310563913118,104.04800706327487 30.672421911947108,104.04846790488524 30.67192519146945,104.0483722240247 30.67028411780783,104.04671460552099 30.668398386635427,104.04532434812747 30.667237854608647,104.04439094637426 30.665536627511973,104.0385074749428 30.668530722755378,104.0372252334524 30.669467379553897,104.03571176398646 30.6701167819357,104.03422625572861 30.671425887624707,104.03372580126796 30.671513105735848,104.03268306641232 30.671271855007976,104.03191746275026 30.6716016666763,104.03105015535002 30.672951301989244,104.02992370520587 30.674285640999916,104.03012297946367 30.676162276402067,104.02902042162287 30.67885196362216,104.02918382566808 30.680312870562894,104.03037593726353 30.681269307294464,104.03027623451534 30.681775337753795,104.02990940228973 30.68204617466318,104.02795574630098 30.682169288875784,104.02635696046949 30.68352697095486,104.0252845158317 30.683997674176105,104.0241882237101 30.68351490370426,104.02367396091002 30.68356430182992,104.02308593882913 30.68398374178747,104.02252780582917 30.684782931865506,104.0221530750954 30.685057853786553,104.02105882153784 30.685370785635577,104.01926703270937 30.68541984738352,104.0182625174487 30.6860324426048,104.01776227272225 30.686055870356444,104.0164748342576 30.685605797349197,104.01534289878208 30.684541576776688,104.01307498196904 30.685177939119388,104.01283585249003 30.684936754891694,104.01262065583781 30.684285687794876,104.01197697575705 30.684295587657882,104.01043847771587 30.68579147536163,104.00908140834714 30.685899479417742,104.00876054320675 30.686692077394518,104.00826432422072 30.687379250360376,104.00822643250514 30.688061050975286,104.00793548177367 30.68837977816218,104.00752099127911 30.688532953647776,104.00569369080982 30.688602430563527,104.00576543886253 30.688336336163157,104.00521348247082 30.688016151748666,104.00495644747686 30.687581129176927,104.00492062435255 30.686559706127174,104.00478711853964 30.686498138434025,104.004105634612 30.686372260431565,104.00373100784198 30.68655531244616,104.00359150487716 30.686953553038773,104.00376084481628 30.687758669875628,104.00365920691674 30.68804884485765,104.00209496572437 30.68844141503646,104.00194950733211 30.688351898466717,104.00194752888235 30.68802805332457,104.00220459825863 30.68758347593914,104.00210896916508 30.687185949104162,104.00139166092033 30.686284544023543,103.99999681810756 30.686388743021524,103.9996221956765 30.68660578488204,103.99957435161554 30.687089708772387,104.00017410030785 30.687789560434673,104.0006084448062 30.688877737428445,104.00174218574294 30.690355606175363,104.00164849482901 30.69120549877146,104.00310711664417 30.69094718516434,104.00366901055732 30.69168713801124,104.00443021353385 30.691478926790527,104.00470119886748 30.69185393270888,104.00631529479416 30.691159375092855,104.0087424380893 30.690562351415732,104.00906324100144 30.691179105675783,104.00915288636673 30.69181054542539,104.00899544566681 30.692138864868788,104.008172445139 30.692237286968,104.008244153277 30.692912758880652,104.00854701804744 30.693573543871842,104.00896348374003 30.69391213867751,104.00865658281063 30.69437284429739,104.00887974653037 30.694873942652954,104.00976053040431 30.695059221725135,104.00985018030794 30.695602701083075,104.00937989043057 30.695630093785933,104.00903313606489 30.696030944769856,104.00866648574981 30.69575017399911,104.00789529560157 30.695916411007936,104.00738913560227 30.69619180455084,104.00724763243149 30.696676004650577,104.00697263367219 30.696820765151173,104.00628714962696 30.6967888465765,104.0059942121922 30.697087591363232,104.0059861983108 30.698069157080482,104.00576697169777 30.69879747850249,104.00615351980215 30.69951797385637,104.00583467499312 30.699882765565377,104.00750254531229 30.70015361100053,104.00755235635891 30.700303390915142,104.00658185009391 30.701725645278163,104.00589636195193 30.70183966018202,104.00414086501758 30.700893416567112,104.00213626518556 30.70089949931293,104.00022737868846 30.699733855448073,103.99967940087109 30.699891450892785,103.999486091685 30.7004637714267,103.99897400017863 30.700197456993916,103.99849176936925 30.70059074230188,103.9991333484557 30.701598313403306,103.9990476549135 30.701848456926054,103.9982725054999 30.702328593718015,103.99888020906143 30.703356257110958,103.99737972166444 30.7044163308186,103.99744645368752 30.704889903587183,103.99727107965705 30.70543218173404,103.99783397812777 30.705798292440562,103.99639129845606 30.70635042866824,103.99563708900702 30.70640470127245,103.99538104394318 30.70624355767733,103.99543386816472 30.705791610808046,103.9950781775802 30.705954617064133,103.99460194359793 30.705866109148584,103.9937919706143 30.705138918291688,103.99316230232853 30.705022887980196,103.99291022771519 30.705149594204695,103.99234526259673 30.70630476353585,103.99118654273397 30.70609837642723,103.98978466515415 30.70685625999002,103.98970298212399 30.706464692460656,103.98899855069963 30.706826647603865,103.9882722194974 30.706626931338732,103.98818051668684 30.70750878906909,103.98772216994195 30.708025922365078,103.9868124947849 30.707902712282564,103.98545250061878 30.706517438773226,103.98536682306266 30.706249821324842,103.98579526995971 30.706198565999973,103.98699886869422 30.70667473603241,103.98724099476172 30.70646211012528,103.98733268931582 30.705790153076943,103.98624367719498 30.7053376323784,103.9852891463731 30.70529050725009,103.9840885675555 30.703526914588046,103.98411448469551 30.703278954527157,103.98496941269984 30.702810631350665,103.98677085893384 30.70300715349089,103.98735772819371 30.702789494976834,103.98752812255425 30.702411161268717,103.9875461118906 30.70114370332001,103.98687957612327 30.700394056310756,103.98680287748232 30.69989052249123,103.98699420866008 30.699232257087907,103.9873060891453 30.69881551606737,103.98792583240599 30.698659726275917,103.98874084424189 30.698793209441693,103.98907263676142 30.698600299066538,103.98895912009347 30.697053364291293,103.9882228134641 30.697115554101742,103.98770473260484 30.696535383359496,103.98721949773372 30.696680773344497,103.98675616570024 30.697169935178017,103.98651106022949 30.69712668990445,103.9864602602331 30.69677900428315,103.98604876192084 30.696668287636218,103.98442165328855 30.69684505874622,103.98341230681798 30.696582177558813,103.98213290359816 30.696561967235315,103.9808286479151 30.69459471462809,103.98026366665928 30.694386463907197,103.97983717419876 30.694525643652174,103.97850883011816 30.69539709666686,103.97641405769996 30.69787196926383,103.97448568476604 30.698922957649643,103.9736305879282 30.699609043933737,103.97338040368723 30.70052131784491,103.97288008928979 30.700978502729992,103.971470840614 30.701436202162796,103.97096950983591 30.70181540631861,103.97075321075738 30.702383733687274,103.97089371151344 30.70304503599325,103.97182152622969 30.704511782755205,103.97164408387799 30.705473819198026,103.97095735476232 30.70639327873108,103.97154833317555 30.707191270309895,103.97156227369533 30.707483093283063,103.97074400310025 30.70795912247713,103.97046493655891 30.70796988317069,103.96978820789019 30.707619899258493,103.96925796532038 30.707669318032448,103.9688901697381 30.707942185048864,103.9688960938224 30.709261541656993,103.96926680995377 30.710619889785704,103.96888302935405 30.71178037560131,103.96864674042685 30.71337824955308,103.9676430047629 30.714060620353205,103.96409142055964 30.7141759111465,103.96217141478397 30.714636604765207,103.9614476538047 30.714570462692247,103.96034604518445 30.714075451120294,103.9599791609366 30.71402038590563,103.95934008164807 30.714203870754055,103.95917555465029 30.714704033688378,103.95958224965874 30.71663011007199,103.95932997475018 30.71744233808393,103.95861407694991 30.718413616720763,103.95789119784543 30.719007078631414,103.95702175617423 30.718963181707952,103.95547620335287 30.719658487830504,103.95454087652648 30.71948873701414,103.95399839169986 30.719865798426028,103.95343095032509 30.72059673517557,103.95398131041016 30.722928352011316,103.95579106069782 30.725283019481562,103.95423149507225 30.72555050246001,103.95244942647649 30.72637613030946,103.95120181875953 30.726624767038512,103.94618883905346 30.726887168653164))';
			let feature = format.readFeature(wktstr)
			let wkt = format.writeFeature(feature, {
				dataProjection: 'EPSG:3857',
				featureProjection: 'EPSG:4326'
			});
			for(var i = 0; i < 13; i++) {
				var wktfeature = format.readFeature(wkt);
				wktfeature.setStyle(new ol.style.Style({
					stroke: new ol.style.Stroke({
						color: [63, 165, 240, 1 / (13 - i)],
						width: (13 - i) * 2 - 1
					})
				}))
				rangeLyaer.getSource().addFeature(wktfeature);
			}
			setTimeout(() => {
				let size = map.getSize();
				if(rangeLyaer.getSource().getFeatures().length) {
					let extent = rangeLyaer.getSource().getExtent();
					map.getView().fit(extent, {
						size: [size[0] * 1, size[1] * 1]
					});
				}
			}, 300)
		</script>
	</body>

</html>