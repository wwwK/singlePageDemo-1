<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>等值线</title>
		<script src="../js/Contour.js"></script>
		<script src="../js/turf.min.js"></script>
		<script src="../js/isoband.js"></script>
		<script src="../js/jquery.min.js"></script>
	</head>

	<body>
		<canvas id="canvaslayer" width="2200" height="1100" style="background-color: #FFFFFF;"></canvas>
		<button id="export">EXPORT</button>
		<script>
			var tibetPolygon = [

				[87.36534102, 36.41574498],
				[87.45273602, 36.41765198],
				[87.473747, 36.36130101],
				[87.55663301, 36.34467701],
				[87.73235298, 36.38700101],
				[87.88671898, 36.37297401],
				[87.97755398, 36.44052099],
				[88.46526302, 36.48477201],
				[88.49341602, 36.448864],
				[88.58371001, 36.457165],
				[88.762932, 36.30406998],
				[88.92093699, 36.36725199],
				[89.12583198, 36.255638],
				[89.231468, 36.29752],
				[89.48501602, 36.153763],
				[89.72012301, 36.085022],
				[89.42652902, 36.042645],
				[89.40000202, 35.99999999],
				[89.420654, 35.92338201],
				[89.52918198, 35.86890799],
				[89.79622701, 35.85304601],
				[89.72285501, 35.654316],
				[89.76136002, 35.59236101],
				[89.69962299, 35.54735199],
				[89.761742, 35.48016701],
				[89.49705498, 35.365894],
				[89.52862501, 35.28334002],
				[89.45188099, 35.23173099],
				[89.51874502, 35.13637201],
				[89.58807399, 35.114403],
				[89.58656299, 34.89826601],
				[89.800491, 34.91942601],
				[89.865738, 34.813816],
				[89.72785202, 34.72564298],
				[89.74029498, 34.649025],
				[89.79670698, 34.62819702],
				[89.80066701, 34.40269101],
				[89.87026202, 34.33746701],
				[89.82682002, 34.298862],
				[89.81170699, 34.16849102],
				[89.69282498, 34.12739598],
				[89.64321898, 34.053848],
				[89.79058798, 33.87128099],
				[89.927971, 33.80450799],
				[89.90711198, 33.74762001],
				[89.98383302, 33.721275],
				[89.98716698, 33.63319398],
				[90.22980501, 33.50553499],
				[90.23843399, 33.40645202],
				[90.344711, 33.29165301],
				[90.48970802, 33.26451502],
				[90.70667998, 33.13914101],
				[90.84547402, 33.116791],
				[90.97919502, 33.24159598],
				[91.16494801, 33.24159199],
				[91.22144302, 33.326752],
				[91.388626, 33.31985101],
				[91.41313202, 33.28940601],
				[91.37056002, 33.25178901],
				[91.47462502, 33.116699],
				[91.83850899, 32.94905101],
				[91.96091499, 32.82118198],
				[92.19111602, 32.868832],
				[92.22811101, 32.835468],
				[92.202118, 32.75189599],
				[92.25974998, 32.72269399],
				[92.35835302, 32.76604798],
				[92.64126598, 32.72325899],
				[92.691666, 32.76778],
				[92.86553998, 32.70034398],
				[93.01457198, 32.74442299],
				[93.06499498, 32.62994799],
				[93.24339298, 32.663788],
				[93.37724301, 32.530987],
				[93.46072399, 32.558582],
				[93.51981398, 32.47835201],
				[93.72155, 32.58090199],
				[93.81253798, 32.55495799],
				[93.86292301, 32.47414798],
				[93.962013, 32.48911301],
				[94.13578002, 32.435955],
				[94.20251499, 32.51846302],
				[94.36606601, 32.524429],
				[94.38993098, 32.599648],
				[94.45346101, 32.57021701],
				[94.61281602, 32.673523],
				[94.81520099, 32.48446999],
				[94.89679002, 32.459881],
				[94.93249501, 32.38464],
				[94.906372, 32.35126501],
				[95.07678199, 32.25176599],
				[95.30516098, 32.25606499],
				[95.35559101, 32.17604101],
				[95.43095398, 32.16090401],
				[95.44196299, 32.01099401],
				[95.37197901, 31.964407],
				[95.52100398, 31.75142099],
				[95.63840501, 31.785227],
				[95.752228, 31.76284998],
				[95.81805398, 31.68039101],
				[95.86953001, 31.722654],
				[96.09284998, 31.71706999],
				[96.14687299, 31.68568201],
				[96.19660199, 31.54294402],
				[96.24636799, 31.555466],
				[96.21646102, 31.62054599],
				[96.25206002, 31.689215],
				[96.13425398, 31.82188999],
				[96.248962, 31.93633798],
				[96.33673902, 31.94745801],
				[96.37097898, 31.85960201],
				[96.55770098, 31.72067802],
				[96.67219502, 31.73478698],
				[96.80537399, 31.674013],
				[96.837212, 31.729294],
				[96.75795698, 31.85547998],
				[96.80740399, 31.89731801],
				[96.72452501, 32.028786],
				[96.940453, 31.989716],
				[96.95635201, 32.06869499],
				[97.16329199, 32.03356601],
				[97.23336799, 32.06085999],
				[97.22017698, 32.11251099],
				[97.30648, 32.08584201],
				[97.26232898, 32.19064298],
				[97.288155, 32.28858598],
				[97.41664102, 32.31292699],
				[97.35909999, 32.33870699],
				[97.411346, 32.36762602],
				[97.33813498, 32.44665902],
				[97.37481698, 32.53068198],
				[97.67261498, 32.47740199],
				[97.75667602, 32.53547302],
				[98.19545701, 32.36264402],
				[98.225304, 32.23285301],
				[98.43197599, 32.013504],
				[98.41481802, 31.83410501],
				[98.62092601, 31.593319],
				[98.88336202, 31.38038301],
				[98.78008998, 31.25496699],
				[98.63451398, 31.340151],
				[98.60282899, 31.189425],
				[98.79892002, 31.009912],
				[98.78086902, 30.89475799],
				[98.96163198, 30.76274101],
				[98.904213, 30.687649],
				[98.985069, 30.16204999],
				[99.06935899, 29.93573799],
				[98.99399602, 29.67821698],
				[99.112312, 29.25112],
				[98.962982, 29.18726699],
				[99.01851702, 29.04395501],
				[98.920929, 28.97832499],
				[98.91525298, 28.91754198],
				[98.97049699, 28.83771499],
				[98.84078198, 28.81069202],
				[98.77833602, 29.00311699],
				[98.63123302, 28.97503101],
				[98.685196, 28.74048398],
				[98.59285698, 28.67307302],
				[98.621628, 28.50517501],
				[98.68175498, 28.47414598],
				[98.753098, 28.33836199],
				[98.70772598, 28.230953],
				[98.62426802, 28.16294901],
				[98.54943099, 28.181711],
				[98.404045, 28.106567],
				[98.29145102, 28.39694201],
				[98.20338399, 28.35533001],
				[98.26612901, 28.24566699],
				[98.17092098, 28.21312301],
				[98.13738302, 28.14764801],
				[98.07434101, 28.20641501],
				[98.029648, 28.190599],
				[98.01663198, 28.263216],
				[97.943123, 28.27976601],
				[97.90859998, 28.34568799],
				[97.79952202, 28.318251],
				[97.726112, 28.47633599],
				[97.66061399, 28.53792199],
				[97.56925198, 28.54517002],
				[97.50679002, 28.48778199],
				[97.477737, 28.28445101],
				[97.41523698, 28.29823499],
				[97.40894299, 28.25162301],
				[97.34466602, 28.23769801],
				[97.34378099, 28.11746398],
				[97.30481002, 28.07276299],
				[97.410851, 28.01822702],
				[97.38564299, 27.88384201],
				[97.24803199, 27.89214699],
				[97.091331, 27.742918],
				[96.96872699, 27.86186002],
				[96.67443798, 27.95797501],
				[96.42992399, 28.16657298],
				[96.374367, 28.11753301],
				[96.30467201, 28.14479603],
				[96.264435, 28.24234998],
				[95.99993901, 28.18968201],
				[95.86936201, 28.29812598],
				[95.81110401, 28.297403],
				[95.39498101, 28.13608898],
				[95.27390302, 27.93255801],
				[94.89197498, 27.74674798],
				[94.52282702, 27.59647],
				[94.29627201, 27.58426999],
				[93.860954, 27.18839101],
				[93.81929802, 27.02974102],
				[93.57546998, 26.939072],
				[93.12885302, 26.87677799],
				[92.78485901, 26.89730498],
				[92.613838, 26.95131101],
				[92.10582002, 26.85498399],
				[92.12252799, 26.95229],
				[92.02430702, 27.08256099],
				[92.07249501, 27.25714499],
				[92.12475601, 27.27659202],
				[92.05297098, 27.40972101],
				[92.00672101, 27.47690998],
				[91.74182899, 27.46432699],
				[91.58380102, 27.54401199],
				[91.56258401, 27.643095],
				[91.64277599, 27.770489],
				[91.61200702, 27.822205],
				[91.54030602, 27.82763299],
				[91.61817199, 27.87849398],
				[91.488525, 27.94049502],
				[91.45536, 28.01140599],
				[91.31572001, 28.06558801],
				[91.25035902, 27.97391699],
				[91.16178099, 27.97073701],
				[91.110268, 27.85065501],
				[91.06105, 27.85327499],
				[90.96365399, 27.904156],
				[90.96372202, 27.95383602],
				[90.88741302, 27.95327398],
				[90.79934701, 28.046919],
				[90.69965399, 28.08127399],
				[90.59069802, 28.02720801],
				[90.37760899, 28.06505799],
				[90.29492202, 28.15686198],
				[90.128365, 28.193413],
				[90.10482, 28.14427797],
				[90.04134398, 28.13763399],
				[89.79613498, 28.25149899],
				[89.77019501, 28.197828],
				[89.601906, 28.16758902],
				[89.50219702, 28.08896601],
				[89.38251502, 27.89205702],
				[89.23452001, 27.79829999],
				[89.22435002, 27.72828698],
				[89.12298599, 27.63460401],
				[89.15942401, 27.57477802],
				[89.09386402, 27.503668],
				[89.17497299, 27.379301],
				[89.06585701, 27.24331701],
				[88.98844901, 27.21412799],
				[88.77862498, 27.46942299],
				[88.76854698, 27.57141501],
				[88.84371901, 27.66494602],
				[88.88362902, 27.85550299],
				[88.83361099, 28.017357],
				[88.75972701, 28.071243],
				[88.63328599, 28.11668398],
				[88.56055498, 28.08575199],
				[88.550827, 28.03535501],
				[88.49216501, 28.047276],
				[88.41075102, 27.98313299],
				[88.25263199, 27.93809098],
				[88.24015, 27.97533801],
				[88.14443198, 27.960461],
				[88.14321899, 27.88893102],
				[88.10290502, 27.86856802],
				[87.83040599, 27.95029599],
				[87.72531099, 27.809122],
				[87.60781099, 27.81567003],
				[87.56113673, 27.86812169],
				[87.455185, 27.82362403],
				[87.40783699, 27.83439098],
				[87.42249298, 27.864065],
				[87.22634101, 27.81666898],
				[87.11888101, 27.83946002],
				[87.04119101, 27.94835499],
				[86.75479901, 28.03438201],
				[86.70817598, 28.104486],
				[86.619957, 28.069727],
				[86.56375624, 28.10533529],
				[86.51510987, 27.96430352],
				[86.41290298, 27.90800299],
				[86.22590602, 27.97996301],
				[86.18033427, 28.16973284],
				[86.07692701, 28.08707402],
				[86.12612901, 27.929518],
				[85.98789999, 27.91489801],
				[85.85221101, 28.16937599],
				[85.75572199, 28.22354699],
				[85.70557401, 28.38111099],
				[85.60179102, 28.25540899],
				[85.59716799, 28.30084199],
				[85.49404102, 28.339005],
				[85.28860501, 28.28295498],
				[85.12064401, 28.340603],
				[85.10042598, 28.46044201],
				[85.185638, 28.540983],
				[85.185837, 28.642151],
				[85.056442, 28.676886],
				[84.97940099, 28.59003099],
				[84.84925101, 28.57544699],
				[84.690468, 28.63786099],
				[84.62653402, 28.733263],
				[84.460732, 28.753042],
				[84.40256501, 28.85902199],
				[84.22803176, 28.89399942],
				[84.24643699, 29.03382099],
				[84.19073498, 29.04989801],
				[84.16093201, 29.18757821],
				[84.19498399, 29.24184998],
				[84.12040699, 29.24426301],
				[84.09438152, 29.29759213],
				[83.91548199, 29.324638],
				[83.708717, 29.23870702],
				[83.64566801, 29.16579798],
				[83.54267099, 29.199894],
				[83.447327, 29.30019401],
				[83.42023498, 29.40986102],
				[83.27661901, 29.50414499],
				[83.26190198, 29.575609],
				[83.14604201, 29.62024902],
				[83.08454101, 29.601688],
				[82.92970567, 29.70486317],
				[82.83113898, 29.68898999],
				[82.691803, 29.76448601],
				[82.73336802, 29.82113101],
				[82.62170401, 29.83752602],
				[82.642883, 29.87033701],
				[82.55180402, 29.958498],
				[82.17330321, 30.06767767],
				[82.20544399, 30.14760201],
				[82.09939598, 30.23976902],
				[82.09790001, 30.35038401],
				[81.99240101, 30.32220301],
				[81.62274201, 30.44472102],
				[81.56128702, 30.425453],
				[81.54744701, 30.372332],
				[81.40879102, 30.41675401],
				[81.395073, 30.20952199],
				[81.26364102, 30.15593901],
				[81.28893301, 30.10201799],
				[81.24952702, 30.01326402],
				[81.15486102, 30.00976199],
				[81.092598, 30.05453298],
				[81.02969398, 30.247311],
				[80.80976902, 30.32037899],
				[80.60549898, 30.46619401],
				[80.534943, 30.45420299],
				[80.30268102, 30.56672998],
				[80.13211802, 30.55636799],
				[80.04173298, 30.596684],
				[79.90230599, 30.83979201],
				[79.825984, 30.85111501],
				[79.67849698, 30.97880902],
				[79.596283, 30.91914202],
				[79.50519602, 31.02866402],
				[79.42367599, 31.02744502],
				[79.40419001, 31.06898499],
				[79.307983, 31.00859599],
				[79.32051799, 30.95978399],
				[79.22018401, 30.95592101],
				[79.17967998, 31.01641801],
				[79.08030702, 31.00651002],
				[78.99528502, 31.05223299],
				[78.993576, 31.16792699],
				[78.86838501, 31.31068601],
				[78.762848, 31.334558],
				[78.79049699, 31.44209303],
				[78.72089402, 31.51355598],
				[78.84754199, 31.607107],
				[78.64888799, 31.82220501],
				[78.76373299, 31.94206399],
				[78.59310899, 32.03385899],
				[78.606316, 32.06177499],
				[78.50851401, 32.14862802],
				[78.448715, 32.15090601],
				[78.42811601, 32.20018002],
				[78.50891102, 32.31074897],
				[78.40075698, 32.54040901],
				[78.73965501, 32.706184],
				[78.77983098, 32.48837702],
				[78.969765, 32.333675],
				[79.00317398, 32.37753299],
				[79.10424001, 32.369568],
				[79.13208799, 32.47322501],
				[79.25772898, 32.51802801],
				[79.30761698, 32.605118],
				[79.27209498, 32.67593798],
				[79.29886601, 32.725113],
				[79.22503702, 32.79650102],
				[79.25236502, 32.94501501],
				[79.160965, 33.01222997],
				[79.16423001, 33.17656701],
				[78.94260398, 33.38585998],
				[78.84373499, 33.424458],
				[78.73716701, 33.56051601],
				[78.760017, 33.62431301],
				[78.68648499, 33.65866901],
				[78.77730598, 33.735401],
				[78.74515498, 33.99508998],
				[78.65763781, 34.0362528],
				[78.65828699, 34.08580399],
				[78.92614699, 34.15520099],
				[78.97406802, 34.31682201],
				[79.04371598, 34.32528701],
				[79.12086501, 34.43666501],
				[79.22739402, 34.415802],
				[79.81623798, 34.496918],
				[79.88523899, 34.62961601],
				[79.86123699, 34.66691201],
				[79.91910598, 34.700977],
				[79.86662301, 34.749565],
				[79.88532301, 34.85153599],
				[79.99202002, 34.86211001],
				[80.04341901, 35.05069699],
				[80.20503201, 35.15320601],
				[80.29506698, 35.26585401],
				[80.29357101, 35.36070599],
				[80.42349999, 35.44213099],
				[80.53040302, 35.454288],
				[80.549469, 35.398239],
				[80.65464798, 35.39835],
				[80.68712602, 35.33997001],
				[80.96150999, 35.312107],
				[81.038719, 35.318619],
				[81.02658801, 35.38238899],
				[81.09561199, 35.41075501],
				[81.216896, 35.32008399],
				[81.43631001, 35.35905101],
				[81.55296298, 35.24486898],
				[81.67232502, 35.23462299],
				[82.013412, 35.32867801],
				[82.04200701, 35.44932602],
				[82.31691701, 35.554111],
				[82.33316798, 35.65196598],
				[82.454277, 35.71908999],
				[82.72863798, 35.63856499],
				[82.789917, 35.687416],
				[82.95826702, 35.672325],
				[82.99623901, 35.485298],
				[83.123726, 35.39918898],
				[83.48437498, 35.39956701],
				[83.53900101, 35.34259401],
				[83.61963699, 35.336491],
				[83.88014201, 35.36533701],
				[83.99069198, 35.42215699],
				[84.17860399, 35.358906],
				[84.44983699, 35.47876002],
				[84.45112601, 35.54835099],
				[84.83635698, 35.64012101],
				[85.03217299, 35.74702499],
				[85.26630399, 35.78048698],
				[85.52408599, 35.71162001],
				[85.52455898, 35.65922898],
				[85.59609201, 35.646599],
				[85.697166, 35.75167501],
				[85.95331602, 35.78454999],
				[86.052307, 35.84610699],
				[86.12786101, 36.009209],
				[86.177254, 36.03277199],
				[86.19339001, 36.12519101],
				[86.24996901, 36.15980098],
				[86.67237101, 36.237049],
				[86.756126, 36.29508599],
				[86.86364002, 36.30799901],
				[86.90626501, 36.26731901],
				[86.993622, 36.309135],
				[87.14149501, 36.298466],
				[87.36534102, 36.41574498]

			];
			var canvas = document.getElementById("canvaslayer");
			var context = canvas.getContext("2d");
			context.fillStyle = "white"; // 内部使用白色，如不指定，默认为黑色
			context.strokeStyle = "#008"; // 深蓝色外边框
			context.lineWidth = 1; // 2个像素宽

			context.beginPath();
			context.moveTo(tibetPolygon[0][0] * 100 - 7800, 1100 - (tibetPolygon[0][1] * 100 - 2600));

			for(var i = 1; i < tibetPolygon.length; i++) {
				context.lineTo(tibetPolygon[i][0] * 100 - 7800, 1100 - (tibetPolygon[i][1] * 100 - 2600));
			}
			context.closePath();
//			context.fill();
//			context.stroke();
			context.clip();
			var sampleData = [
				[95.820041, 28.939994, 2.3],
				[88.637541, 28.927494, 5.4],
				[87.167541, 28.629161, 0.4],
				[95.839208, 30.991661, 6.8],
				[94.123374, 30.553328, 3.1],
				[89.267541, 29.740828, 6.2],
				[89.594181, 28.682597, 7.6],
				[97.698374, 30.666661, 1.2],
				[95.268498, 32.201917, 2.3],
				[87.190041, 29.118328, 4.6],
				[90.175850, 29.387233, 7.8],
				[97.093374, 31.186661, 2.1],
				[88.728374, 31.154161, 0.4],
				[85.977541, 31.839994, 5.4],
				[96.567541, 31.243328, 7.6],
				[88.397541, 28.283952, 3.4],
				[93.336708, 29.740828, 4.6],
				[87.667908, 29.954285, 8.7],
				[92.174739, 28.463913, 7.6],
				[97.146708, 30.040828, 7.6],
				[91.672541, 27.524161, 8.8],
				[88.726942, 30.538296, 2.3],
				[85.008374, 29.637494, 4.5],
				[96.614208, 28.988328, 6.7],
				[98.027541, 30.414994, 8.7],
				[91.747541, 29.840828, 4.5],
				[85.798374, 28.747494, 6.3],
				[80.142541, 32.466661, 2.1],
				[95.727456, 28.630249, 3.4],
				[95.613188, 30.055957, 1.8],
				[90.962541, 30.389994, 0.2],
				[93.892541, 29.066661, 4.2]
			];

			var grids = isoBand.isobandGrid(sampleData, 999999, [tibetPolygon])
			var data = [];

			//			for(var i = 0; i < grids.height; i++) {
			//				data[i] = [];
			//				for(var j = 0; j < grids.width; j++) {
			//					data[i].push({
			//						x: grids.data[i * grids.width + j][0] * 100 - 7800,
			//						y: 1100 - (grids.data[i * grids.width + j][1] * 100 - 2600),
			//						value: grids.data[i * grids.width + j][2]
			//					})
			//				}
			//			}
			for(var i = 0; i < grids.width; i++) {
				data[i] = [];
				for(var j = 0; j < grids.height; j++) {
					data[i].push({
						x: grids.data[j * grids.width + i][0] * 100 - 7800,
						y: 1100 - (grids.data[j * grids.width + i][1] * 100 - 2600),
						value: grids.data[j * grids.width + i][2]
					})
				}
			}

			var levelData = [{
					rank: 0,
					color: [155, 255, 252, 0.5]
				},
				{
					rank: 1,
					color: [0, 207, 254, 0.5]
				},
				{
					rank: 2,
					color: [0, 156, 255, 0.5]
				},
				{
					rank: 3,
					color: [6, 100, 255, 0.5]
				},
				{
					rank: 4,
					color: [38, 159, 0, 0.5]
				},
				{
					rank: 5,
					color: [36, 255, 0, 0.5]
				},
				{
					rank: 6,
					color: [247, 255, 0, 0.5]
				},
				{
					rank: 7,
					color: [253, 203, 10, 0.5]
				},
				{
					rank: 8,
					color: [243, 160, 6, 0.5]
				},
				{
					rank: 9,
					color: [254, 1, 0, 0.5]
				}
			]

			var levels = [];

			for(var i = 0; i < levelData.length; i++) {
				levels.push(levelData[i].rank)
			}
			var colors = [];
			for(var i = 0; i < levelData.length; i++) {
				colors.push(levelData[i].color)
			}

			var con = new Contour(data);

			con.setContourLevel(levels);
			var all_iso_line = con.track();

			for(var i = 0; i < all_iso_line.length; i++) {
				for(var j = 0; j < levels.length; j++) {
					if(all_iso_line[i].value == levels[j]) {
						context.fillStyle = "rgba(" + colors[j][0] + "," + colors[j][1] + "," + colors[j][2] + ",1)"; // 内部使用白色，如不指定，默认为黑色
//						context.strokeStyle = "#FFF"; // 深蓝色外边框
						context.lineWidth = 0; // 2个像素宽
						
						context.beginPath();
						context.moveTo(all_iso_line[i].path[0].x, all_iso_line[i].path[0].y);
						for(var k = 1; k < all_iso_line[i].path.length; k++) {
							context.lineTo(all_iso_line[i].path[k].x, all_iso_line[i].path[k].y);
						}
						context.closePath();
						context.fill();
//						context.stroke();
					}
				}
			}
			
			$('#export').click(function() {
				var canvas = document.getElementById("canvaslayer");
				var image = new Image();
				image.src = canvas.toDataURL("image/png");
				console.log(image)
			})
		</script>
	</body>

</html>